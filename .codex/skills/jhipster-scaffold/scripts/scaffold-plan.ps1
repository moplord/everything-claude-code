param(
  [Parameter(Mandatory = $true)]
  [string]$OutDir,

  [Parameter(Mandatory = $true)]
  [string]$BaseName,

  [Parameter(Mandatory = $true)]
  [string]$PackageName,

  [Parameter(Mandatory = $true)]
  [string]$OidcIssuerUri,

  [Parameter(Mandatory = $true)]
  [string]$OidcClientId
)

$ErrorActionPreference = "Stop"

function Ensure-Dir {
  param([string]$p)
  if (!(Test-Path $p)) { New-Item -ItemType Directory -Force -Path $p | Out-Null }
}

function Json-Quote {
  param([string]$s)
  # Robust JSON quoting without hand-rolled escaping.
  return ($s | ConvertTo-Json -Compress)
}

$outAbs = (Resolve-Path -LiteralPath $OutDir -ErrorAction SilentlyContinue)
if (-not $outAbs) {
  Ensure-Dir -p $OutDir
  $outAbs = (Resolve-Path -LiteralPath $OutDir).Path
} else {
  $outAbs = $outAbs.Path
}

$now = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

$plan = @()
$plan += "# JHipster Scaffold Plan"
$plan += ""
$plan += "> Generated by scaffold-plan.ps1 at $now"
$plan += ""
$plan += "## Baseline"
$plan += ""
$plan += "- Architecture: monolith"
$plan += "- Client: Vue3"
$plan += "- Auth: oauth2-oidc"
$plan += "- Build: Maven"
$plan += "- Database: PostgreSQL"
$plan += "- i18n: disabled"
$plan += "- Multi-tenancy: disabled"
$plan += ""
$plan += "## Required Inputs (Per Project)"
$plan += ""
$plan += "- BaseName: $BaseName"
$plan += "- PackageName: $PackageName"
$plan += "- OIDC Issuer URI: $OidcIssuerUri"
$plan += "- OIDC Client ID: $OidcClientId"
$plan += ""
$plan += "## Next Step (Manual)"
$plan += ""
$plan += "1) Install JHipster CLI in your environment (project decides version)."
$plan += "2) Run the generator in this target folder."
$plan += "3) Commit the generated scaffold."
$plan += ""
$plan += "## Notes"
$plan += ""
$plan += "- This plan intentionally does not lock a JHipster version."
$plan += "- A future automation step can pin versions and run generation non-interactively."
$plan += ""

Set-Content -NoNewline -Encoding UTF8 -Path (Join-Path $outAbs "JHIPSTER_SCAFFOLD_PLAN.md") -Value ($plan -join "`n")

# Generate a minimal .yo-rc.json stub (fields vary by JHipster version; treat as a parameter record).
$yo = @()
$yo += "{"
$yo += '  "generator-jhipster": {'
$yo += '    "baseName": ' + (Json-Quote -s $BaseName) + ','
$yo += '    "packageName": ' + (Json-Quote -s $PackageName) + ','
$yo += '    "applicationType": "monolith",'
$yo += '    "authenticationType": "oauth2",'
$yo += '    "databaseType": "sql",'
$yo += '    "devDatabaseType": "postgresql",'
$yo += '    "prodDatabaseType": "postgresql",'
$yo += '    "buildTool": "maven",'
$yo += '    "clientFramework": "vue",'
$yo += '    "enableTranslation": false'
$yo += '  },'
$yo += '  "codex": {'
$yo += '    "oidc": {'
$yo += '      "issuerUri": ' + (Json-Quote -s $OidcIssuerUri) + ','
$yo += '      "clientId": ' + (Json-Quote -s $OidcClientId)
$yo += '    }'
$yo += '  }'
$yo += "}"

Set-Content -NoNewline -Encoding UTF8 -Path (Join-Path $outAbs ".yo-rc.json") -Value ($yo -join "`n")

Write-Host ("Wrote scaffold plan: " + (Join-Path $outAbs "JHIPSTER_SCAFFOLD_PLAN.md"))
Write-Host ("Wrote .yo-rc.json stub: " + (Join-Path $outAbs ".yo-rc.json"))
